[verification 패키지]

package com.skrrrrr.harudam.verification;

import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Configuration;

@Configuration
@EnableConfigurationProperties(SmsProperties.class)
public class SmsConfig {
}

----
package com.skrrrrr.harudam.verification;

import org.springframework.boot.context.properties.ConfigurationProperties;

import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@ConfigurationProperties(prefix = "sms.twilio")
public class SmsProperties {
	
    // Twilio 계정 설정
    private String accountSid;
    private String authToken;
    private String from;

    // 메시지 템플릿: {code}, {ttlMinutes} 치환
    private String template = "[하루담] 인증번호 {code} (유효 {ttlMinutes}분)";
}

----
package com.skrrrrr.harudam.verification;

public interface SmsSender {
	
    /**
     * @param toE164  수신자 번호 (예: +821012345678)
     * @param message 전송할 최종 메시지
     */
    void send(String toE164, String message);
}
----
package com.skrrrrr.harudam.verification;

import org.springframework.stereotype.Component;

import com.twilio.Twilio;
import com.twilio.rest.api.v2010.account.Message;
import com.twilio.type.PhoneNumber;

import lombok.RequiredArgsConstructor;

@Component
@RequiredArgsConstructor
public class TwilioSmsSender implements SmsSender {

    private final SmsProperties props;

    @Override
    public void send(String toE164, String message) {
        Twilio.init(props.getAccountSid(), props.getAuthToken());
        Message.creator(
                new PhoneNumber(toE164),
                new PhoneNumber(props.getFrom()),
                message
        ).create();
    }
}

----
package com.skrrrrr.harudam.verification;

import java.time.ZonedDateTime;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;

@RestController
@RequestMapping("/api/verification")
@RequiredArgsConstructor
@CrossOrigin(origins = "http://localhost:5173")
public class VerificationController {

    private final VerificationService verificationService;

    /* ===================== 요청 DTO ===================== */
    @Getter
    @NoArgsConstructor
    public static class SendChildCodeReq {
        private Long childId;
        private String phone;
    }

    @Getter
    @NoArgsConstructor
    public static class SendParentCodeReq {
        private String phone;
    }
    @Getter
    @NoArgsConstructor
    public static class VerifyChildReq {
        private String phone;
        private String code;
    }

    @Getter
    @NoArgsConstructor
    public static class VerifyParentCodeReq {
        private String phone;
        private String code;
    }

    /* ===================== 응답 DTO ===================== */
    @Getter
    @AllArgsConstructor
    public static class SimpleRes {
        private final boolean success;
        private final String message;
        private final ZonedDateTime expiresAt; // ✅ 만료 시각
        private final Integer ttlSeconds;      // ✅ TTL(초)
    }

    /* ===================== 자녀 인증 ===================== */
    @PostMapping("/send-child")
    public ResponseEntity<SimpleRes> sendChildCode(@RequestBody SendChildCodeReq req) {
        if (req == null || req.getChildId() == null || req.getPhone() == null || req.getPhone().isBlank()) {
            return ResponseEntity.badRequest()
                    .body(new SimpleRes(false, "childId, phone을 입력하세요.", null, null));
        }

        VerificationService.SendCodeResult result = verificationService.sendChildCode(req.getChildId(), req.getPhone());
        return ResponseEntity.ok(
                new SimpleRes(true, "자녀 인증번호를 전송했습니다.", result.getExpiresAt(), result.getTtlSeconds())
        );
    }

    @PostMapping("/verify-child")
    public ResponseEntity<SimpleRes> verifyChildCode(@RequestBody VerifyChildReq req) {
        if (req == null || req.getPhone() == null || req.getPhone().isBlank()
                || req.getCode() == null || req.getCode().isBlank()) {
            return ResponseEntity.badRequest()
                    .body(new SimpleRes(false, "phone, code를 입력하세요.", null, null));
        }

        boolean ok = verificationService.verifyChildCode(req.getPhone(), req.getCode());
        if (ok) {
            return ResponseEntity.ok(new SimpleRes(true, "자녀 인증 성공", null, null));
        }
        return ResponseEntity.badRequest().body(new SimpleRes(false, "자녀 인증 실패", null, null));
    }

    /* ===================== 부모 인증 ===================== */
    @PostMapping("/send-parent")
    public ResponseEntity<SimpleRes> sendParentCode(@RequestBody SendParentCodeReq req) {
        if (req == null || req.getPhone() == null || req.getPhone().isBlank()) {
            return ResponseEntity.badRequest()
                .body(new SimpleRes(false, "phone을 입력하세요.", null, null));
        }

        VerificationService.SendCodeResult result = verificationService.sendParentCode(req.getPhone());
        return ResponseEntity.ok(
            new SimpleRes(true, "부모님 동의 후 인증번호를 전송했습니다.", result.getExpiresAt(), result.getTtlSeconds())
        );
    }

    @PostMapping("/verify-parent")
    public ResponseEntity<SimpleRes> verifyParentCode(@RequestBody VerifyParentCodeReq req) {
        if (req == null || req.getPhone() == null || req.getPhone().isBlank()
                || req.getCode() == null || req.getCode().isBlank()) {
            return ResponseEntity.badRequest()
                .body(new SimpleRes(false, "phone, code를 입력하세요.", null, null));
        }

        boolean ok = verificationService.verifyParentCode(req.getPhone(), req.getCode());
        if (ok) {
            return ResponseEntity.ok(new SimpleRes(true, "인증 성공", null, null));
        }
        return ResponseEntity.badRequest().body(new SimpleRes(false, "인증 실패", null, null));
    }
}

----
package com.skrrrrr.harudam.verification;

import java.security.SecureRandom;
import java.time.ZonedDateTime;

import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.skrrrrr.harudam.auth.AuthCode;
import com.skrrrrr.harudam.auth.AuthCodeRepository;
import com.skrrrrr.harudam.common.enums.AuthCodePurpose;
import com.skrrrrr.harudam.common.enums.AuthCodeStatus;
import com.skrrrrr.harudam.common.enums.UserState;
import com.skrrrrr.harudam.member.ChildUser;
import com.skrrrrr.harudam.member.ChildUserRepository;
import com.skrrrrr.harudam.member.ParentUser;
import com.skrrrrr.harudam.member.ParentUserRepository;
import com.skrrrrr.harudam.member.dto.ChildSignupReq;
import com.skrrrrr.harudam.member.dto.ParentSignupReq;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class VerificationService {

    /** 인증코드 길이/TTL(초) */
    private static final int CODE_LENGTH = 6;
    private static final int TTL_SECONDS = 180; // 3분
    private static final SecureRandom RNG = new SecureRandom();

    private final AuthCodeRepository authCodeRepository;
    private final ChildUserRepository childUserRepository;
    private final ParentUserRepository parentUserRepository;
    private final SmsSender smsSender;
    private final SmsProperties smsProperties;

    /** 프론트에 만료정보를 내려주기 위한 반환 DTO */
    @Getter
    @AllArgsConstructor
    public static class SendCodeResult {
        private final ZonedDateTime expiresAt; // 서버 기준 만료 시각
        private final int ttlSeconds;          // 남은 TTL(초)
    }

    /* ===================== 자녀 인증 ===================== */
    @Transactional
    public SendCodeResult sendChildCode(Long childId, String phone) {
        ChildUser child = childUserRepository.findById(childId)
                .orElseThrow(() -> new IllegalArgumentException("자녀를 찾을 수 없습니다. id=" + childId));

        String digits = normalizeDigits(phone);
        String toE164 = toE164Kr(digits);

        // 이전 미사용 코드 만료 처리
        authCodeRepository.findTopByTargetParentPhoneAndStatusOrderByCreatedAtDesc(digits, AuthCodeStatus.ISSUED)
                .ifPresent(c -> c.setStatus(AuthCodeStatus.EXPIRED));

        // 새 코드 생성
        String code = generate();
        ZonedDateTime now = ZonedDateTime.now();
        ZonedDateTime expiresAt = now.plusSeconds(TTL_SECONDS);

        AuthCode ac = new AuthCode();
        ac.setCodeValue(code);
        ac.setIssuedByChild(child);
        ac.setTargetParentPhone(digits);
        ac.setStatus(AuthCodeStatus.ISSUED);
        ac.setPurpose(AuthCodePurpose.SIGNUP);
        ac.setExpiresAt(expiresAt);
        authCodeRepository.save(ac);

        // 문자 발송
        String msg = smsProperties.getTemplate()
                .replace("{code}", code)
                .replace("{ttlMinutes}", String.valueOf(TTL_SECONDS / 60));
        smsSender.send(toE164, msg);

        return new SendCodeResult(expiresAt, TTL_SECONDS);
    }

    @Transactional
    public boolean verifyChildCode(String phone, String code) {
        String digits = normalizeDigits(phone);

        AuthCode target = authCodeRepository
                .findTopByTargetParentPhoneAndStatusOrderByCreatedAtDesc(digits, AuthCodeStatus.ISSUED)
                .orElse(null);

        if (target == null) return false;
        if (ZonedDateTime.now().isAfter(target.getExpiresAt())) {
            target.setStatus(AuthCodeStatus.EXPIRED);
            return false;
        }
        if (!target.getCodeValue().equals(code)) return false;

        target.setStatus(AuthCodeStatus.USED);
        target.setUsedAt(ZonedDateTime.now());

        return true;
    }
    
    /* ===================== 자녀 정보 저장 ===================== */
    @Transactional
    public void finalizeChildSignup(ChildSignupReq req) {
        ChildUser child = childUserRepository.findById(req.getChildId())
                .orElseThrow(() -> new IllegalArgumentException("자녀를 찾을 수 없습니다. id=" + req.getChildId()));

        child.setPhone(req.getPhone());
        child.setBirth(req.getBirth());
        child.setGender(req.getGender());
        child.setAddr1(req.getAddr1());
        child.setAddr2(req.getAddr2());
        child.setPictureUrl(req.getPictureUrl());
        child.setVoiceUrl(req.getVoiceUrl());
        child.setState(UserState.ACTIVE);

        childUserRepository.save(child);
    }

    /* ===================== 부모 인증 ===================== */
    @Transactional
    public SendCodeResult sendParentCode(String phone) {
        String digits = normalizeDigits(phone);
        String toE164 = toE164Kr(digits);

        authCodeRepository.findTopByTargetParentPhoneAndStatusOrderByCreatedAtDesc(digits, AuthCodeStatus.ISSUED)
            .ifPresent(c -> c.setStatus(AuthCodeStatus.EXPIRED));

        String code = generate();
        ZonedDateTime now = ZonedDateTime.now();
        ZonedDateTime expiresAt = now.plusSeconds(TTL_SECONDS);

        AuthCode ac = new AuthCode();
        ac.setCodeValue(code);
        ac.setIssuedByChild(null);
        ac.setTargetParentPhone(digits);
        ac.setStatus(AuthCodeStatus.ISSUED);
        ac.setPurpose(AuthCodePurpose.SIGNUP);
        ac.setExpiresAt(expiresAt);
        authCodeRepository.save(ac);

        String msg = smsProperties.getTemplate()
                .replace("{code}", code)
                .replace("{ttlMinutes}", String.valueOf(TTL_SECONDS / 60));
        smsSender.send(toE164, msg);

        return new SendCodeResult(expiresAt, TTL_SECONDS);
    }

    @Transactional
    public boolean verifyParentCode(String phone, String code) {
        String digits = normalizeDigits(phone);

        AuthCode target = authCodeRepository
                .findTopByTargetParentPhoneAndStatusOrderByCreatedAtDesc(digits, AuthCodeStatus.ISSUED)
                .orElse(null);

        if (target == null) return false;
        if (ZonedDateTime.now().isAfter(target.getExpiresAt())) {
            target.setStatus(AuthCodeStatus.EXPIRED);
            return false;
        }
        if (!target.getCodeValue().equals(code)) return false;

        target.setStatus(AuthCodeStatus.USED);
        target.setUsedAt(ZonedDateTime.now());

        return true;
    }
    
    /* ===================== 부모 정보 저장 ===================== */
    @Transactional
    public ResponseEntity<?> finalizeParentSignup(ParentSignupReq req) {
        ParentUser parent = new ParentUser();
        parent.setName(req.getName());
        parent.setGender(req.getGender());
        parent.setBirth(req.getBirth());
        parent.setPhone(req.getPhone());
        parent.setAddr1(req.getAddr1());
        parent.setAddr2(req.getAddr2());
        parent.setPictureUrl(req.getPictureUrl());
        parent.setState(UserState.ACTIVE);

        parentUserRepository.save(parent);
        return ResponseEntity.ok("부모 회원가입 완료");
    }

    /* ===================== 유틸 ===================== */
    private static String generate() {
        StringBuilder sb = new StringBuilder(CODE_LENGTH);
        for (int i = 0; i < CODE_LENGTH; i++) {
            sb.append(RNG.nextInt(10));
        }
        return sb.toString();
    }

    private static String normalizeDigits(String phone) {
        if (phone == null) return "";
        return phone.replaceAll("\\D", "");
    }

    /** 01012345678 -> +821012345678 */
    private static String toE164Kr(String digits) {
        if (digits.startsWith("0")) {
            return "+82" + digits.substring(1);
        }
        if (digits.startsWith("82")) {
            return "+" + digits;
        }
        return "+82" + digits;
    }
}

